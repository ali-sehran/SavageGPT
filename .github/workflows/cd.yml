name: CD

on:
  push:
    tags:
      - 'v*'
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    if: github.repository_owner == 'ali-sehran' && github.actor == 'ali-sehran'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy systemd unit files
        run: |
          # Copy your infra/*.service into systemd
          sudo cp infra/savagegpt.service    /etc/systemd/system/savagegpt.service
          sudo cp infra/ngrok.service        /etc/systemd/system/ngrok.service

      - name: Reload & enable services
        run: |
          # Reload systemd to pick up new unit files
          sudo systemctl daemon-reload

          # Enable on-boot and restart to pick up any changes
          sudo systemctl enable savagegpt.service
          sudo systemctl enable ngrok.service

      - name: Deploy new code and restart services
        run: |
          # Pull latest code
          cd /opt/savagegpt
          git fetch --tags
          git checkout ${{ github.ref_name }}

          # Restart the FastAPI & ngrok services
          sudo systemctl restart savagegpt.service
          sudo systemctl restart ngrok.service
